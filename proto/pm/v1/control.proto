syntax = "proto3";

package pm.v1;

option go_package = "github.com/manchtools/power-manage/sdk/gen/go/pm/v1;pmv1";

import "google/protobuf/timestamp.proto";
import "pm/v1/common.proto";
import "pm/v1/actions.proto";
import "pm/v1/agent.proto";

// ============================================================================
// Agent Registration (called by agent during first-time setup)
// ============================================================================

message RegisterRequest {
  // @gotags: validate:"required,max=255"
  string token = 1;
  // @gotags: validate:"required,min=1,max=253"
  string hostname = 2;
  // @gotags: validate:"required,min=1,max=32"
  string agent_version = 3;
  // Certificate Signing Request (PEM-encoded PKCS#10)
  // Agent generates its own key pair and sends CSR for signing
  // @gotags: validate:"required"
  bytes csr = 4;
}

message RegisterResponse {
  // @gotags: validate:"required"
  DeviceId device_id = 1;
  // @gotags: validate:"omitempty,max=4096"
  string auth_token = 2;  // Deprecated: use mTLS certificates instead
  // mTLS credentials issued by control server
  // @gotags: validate:"required"
  bytes ca_cert = 3;       // CA certificate (PEM)
  // Signed device certificate (PEM) - private key stays on agent
  // @gotags: validate:"required"
  bytes certificate = 4;
  // Gateway URL for streaming connection (agent stores this for future connections)
  // @gotags: validate:"required,url"
  string gateway_url = 5;
}

// ============================================================================
// Certificate Renewal (called by agent to renew expiring certificates)
// ============================================================================

message RenewCertificateRequest {
  // Certificate Signing Request (PEM-encoded PKCS#10)
  // @gotags: validate:"required"
  bytes csr = 1;
  // Current certificate (PEM) for identity verification
  // @gotags: validate:"required"
  bytes current_certificate = 2;
}

message RenewCertificateResponse {
  // New signed certificate (PEM)
  bytes certificate = 1;
  // Certificate expiry
  google.protobuf.Timestamp not_after = 2;
  // Active CA certificate (PEM). Agents should update their stored CA cert
  // if non-empty, enabling seamless CA rotation.
  bytes ca_certificate = 3;
}

// ============================================================================
// Authentication
// ============================================================================

message LoginRequest {
  // @gotags: validate:"required,email"
  string email = 1;
  // @gotags: validate:"required,min=8"
  string password = 2;
}

message LoginResponse {
  string access_token = 1;
  string refresh_token = 2;
  google.protobuf.Timestamp expires_at = 3;
  User user = 4;
  // When true, TOTP verification is required before tokens are issued.
  // The client must call VerifyLoginTOTP with the totp_challenge.
  bool totp_required = 5;
  // Short-lived challenge token for TOTP verification (only set when totp_required=true).
  string totp_challenge = 6;
}

message RefreshTokenRequest {
  // @gotags: validate:"required"
  string refresh_token = 1;
}

message RefreshTokenResponse {
  string access_token = 1;
  google.protobuf.Timestamp expires_at = 2;
  string refresh_token = 3;
}

message LogoutRequest {
  // @gotags: validate:"required"
  string refresh_token = 1;
}

message LogoutResponse {}

message GetCurrentUserRequest {}

message GetCurrentUserResponse {
  User user = 1;
}

// ============================================================================
// TOTP Two-Factor Authentication
// ============================================================================

message SetupTOTPRequest {}

message SetupTOTPResponse {
  // Base32-encoded TOTP secret for manual entry.
  string secret = 1;
  // otpauth:// URI for QR code generation.
  string qr_uri = 2;
  // One-time backup codes (shown once, user must save them).
  repeated string backup_codes = 3;
}

message VerifyTOTPRequest {
  // @gotags: validate:"required,len=6,numeric"
  string code = 1;
}

message VerifyTOTPResponse {
  bool success = 1;
}

message DisableTOTPRequest {
  // @gotags: validate:"required,min=8"
  string password = 1;
}

message DisableTOTPResponse {}

// Admin: disable TOTP for another user (no password required).
message AdminDisableUserTOTPRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
}

message AdminDisableUserTOTPResponse {}

message GetTOTPStatusRequest {}

message GetTOTPStatusResponse {
  bool enabled = 1;
  int32 backup_codes_remaining = 2;
}

message RegenerateBackupCodesRequest {
  // @gotags: validate:"required,min=8"
  string password = 1;
}

message RegenerateBackupCodesResponse {
  repeated string backup_codes = 1;
}

message VerifyLoginTOTPRequest {
  // Short-lived challenge token from LoginResponse.totp_challenge.
  // @gotags: validate:"required"
  string challenge = 1;
  // 6-digit TOTP code or 8-character backup code.
  // @gotags: validate:"required,min=6,max=8"
  string code = 2;
}

message VerifyLoginTOTPResponse {
  string access_token = 1;
  string refresh_token = 2;
  google.protobuf.Timestamp expires_at = 3;
  User user = 4;
}

// ============================================================================
// Users
// ============================================================================

message User {
  string id = 1;
  string email = 2;
  reserved 3;  // was: string role
  google.protobuf.Timestamp created_at = 4;
  google.protobuf.Timestamp last_login_at = 5;
  bool disabled = 6;
  repeated Role roles = 7;
  bool totp_enabled = 8;
  bool has_password = 9;
  repeated IdentityLink identity_links = 10;
  // OIDC profile scope properties
  string display_name = 11;
  string given_name = 12;
  string family_name = 13;
  string preferred_username = 14;
  string picture = 15;
  string locale = 16;
  // Linux identity
  string linux_username = 17;
  int32 linux_uid = 18;
  // SSH access settings
  repeated SshPublicKey ssh_public_keys = 19;
  bool ssh_access_enabled = 20;
  bool ssh_allow_pubkey = 21;
  bool ssh_allow_password = 22;
  bool user_provisioning_enabled = 23;
}

message SshPublicKey {
  string id = 1;
  string public_key = 2;
  string comment = 3;
  google.protobuf.Timestamp added_at = 4;
}

message Role {
  string id = 1;
  // @gotags: validate:"required,min=1,max=64"
  string name = 2;
  string description = 3;
  repeated string permissions = 4;
  google.protobuf.Timestamp created_at = 5;
  bool is_system = 6;
}

message PermissionInfo {
  string key = 1;
  string group = 2;
  string description = 3;
}

message CreateUserRequest {
  // @gotags: validate:"required,email"
  string email = 1;
  // @gotags: validate:"required,min=8"
  string password = 2;
  // Role IDs to assign to the new user. If empty, the default "User" role is assigned.
  repeated string role_ids = 3;
  // Optional profile fields
  string display_name = 4;
  string given_name = 5;
  string family_name = 6;
  string preferred_username = 7;
}

message CreateUserResponse {
  User user = 1;
}

message GetUserRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetUserResponse {
  User user = 1;
}

message ListUsersRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListUsersResponse {
  repeated User users = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// Granular user updates
message UpdateUserEmailRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,email"
  string email = 2;
}

message UpdateUserPasswordRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty,min=8"
  string current_password = 2;  // Required for self-update
  // @gotags: validate:"required,min=8"
  string new_password = 3;
}

message SetUserDisabledRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  bool disabled = 2;
}

message UpdateUserResponse {
  User user = 1;
}

message UpdateUserProfileRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  string display_name = 2;
  string given_name = 3;
  string family_name = 4;
  // @gotags: validate:"omitempty,max=64"
  string preferred_username = 5;
  // @gotags: validate:"omitempty,max=2048"
  string picture = 6;
  // @gotags: validate:"omitempty,max=10"
  string locale = 7;
}

message DeleteUserRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteUserResponse {}

message AddUserSshKeyRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  // @gotags: validate:"required,min=1,max=8192"
  string public_key = 2;
  // @gotags: validate:"omitempty,max=256"
  string comment = 3;
}

message AddUserSshKeyResponse {
  SshPublicKey key = 1;
}

message RemoveUserSshKeyRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  // @gotags: validate:"required,ulid"
  string key_id = 2;
}

message RemoveUserSshKeyResponse {}

message UpdateUserSshSettingsRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  bool ssh_access_enabled = 2;
  bool ssh_allow_pubkey = 3;
  bool ssh_allow_password = 4;
}

message UpdateUserLinuxUsernameRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  // @gotags: validate:"required,min=1,max=32"
  string linux_username = 2;
}

// ============================================================================
// Devices
// ============================================================================

message Device {
  string id = 1;
  string hostname = 2;
  string agent_version = 3;
  string status = 4;  // "online", "offline"
  google.protobuf.Timestamp registered_at = 5;
  google.protobuf.Timestamp last_seen_at = 6;
  google.protobuf.Timestamp cert_expires_at = 7;
  map<string, string> labels = 8;
  string assigned_user_id = 9;  // User this device is assigned to (empty = unassigned)
  // Sync interval in minutes (0 = use default of 30 minutes)
  // Agent will pull assigned actions at this interval
  int32 sync_interval_minutes = 10;
  // Compliance status based on detection scripts
  ComplianceStatus compliance_status = 11;
  google.protobuf.Timestamp compliance_checked_at = 12;
  int32 compliance_total = 13;    // Total number of compliance checks
  int32 compliance_passing = 14;  // Number of passing checks
}

message ListDevicesRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
  // @gotags: validate:"omitempty,oneof=online offline"
  string status_filter = 3;  // optional: "online", "offline"
  map<string, string> label_filter = 4;
}

message ListDevicesResponse {
  repeated Device devices = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message GetDeviceRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetDeviceResponse {
  Device device = 1;
}

// Granular device updates
message SetDeviceLabelRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=64"
  string key = 2;
  // @gotags: validate:"required,max=256"
  string value = 3;
}

message RemoveDeviceLabelRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=64"
  string key = 2;
}

message UpdateDeviceResponse {
  Device device = 1;
}

message DeleteDeviceRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteDeviceResponse {}

// Device assignment (admin-only)
message AssignDeviceRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,ulid"
  string user_id = 2;
}

message AssignDeviceResponse {
  Device device = 1;
}

message UnassignDeviceRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message UnassignDeviceResponse {
  Device device = 1;
}

// Update device sync interval
message SetDeviceSyncIntervalRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"gte=0,lte=1440"
  int32 sync_interval_minutes = 2;  // 0 = use default (30 min), max 24 hours
}

// ============================================================================
// Registration Tokens
// ============================================================================

message RegistrationToken {
  string id = 1;
  string value = 2;  // Only returned on creation
  string name = 3;
  bool one_time = 4;
  int32 max_uses = 5;  // 0 = unlimited
  int32 current_uses = 6;
  google.protobuf.Timestamp expires_at = 7;
  google.protobuf.Timestamp created_at = 8;
  string created_by = 9;
  bool disabled = 10;
  string owner_id = 11;  // User who owns this token (devices registered with it are assigned to them)
}

message CreateTokenRequest {
  // @gotags: validate:"required,min=1,max=128"
  string name = 1;
  bool one_time = 2;
  // @gotags: validate:"omitempty,min=0"
  int32 max_uses = 3;  // 0 = unlimited (for reusable tokens)
  google.protobuf.Timestamp expires_at = 4;  // optional
}

message CreateTokenResponse {
  RegistrationToken token = 1;
}

message ListTokensRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
  bool include_disabled = 3;
}

message ListTokensResponse {
  repeated RegistrationToken tokens = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message GetTokenRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetTokenResponse {
  RegistrationToken token = 1;
}

// Granular token updates
message RenameTokenRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=128"
  string name = 2;
}

message SetTokenDisabledRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  bool disabled = 2;
}

message UpdateTokenResponse {
  RegistrationToken token = 1;
}

message DeleteTokenRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteTokenResponse {}

// ============================================================================
// Actions (Single Executable - renamed from ActionDefinition)
// ============================================================================

message ManagedAction {
  string id = 1;
  string name = 2;
  string description = 3;
  ActionType type = 4;
  DesiredState desired_state = 5;
  oneof params {
    PackageParams package = 10;
    AppInstallParams app = 11;
    ShellParams shell = 12;
    SystemdParams systemd = 13;
    FileParams file = 14;
    UpdateParams update = 15;
    RepositoryParams repository = 16;
    FlatpakParams flatpak = 17;
    DirectoryParams directory = 18;
    UserParams user = 19;
    SshParams ssh = 22;
    SshdParams sshd = 23;
    SudoParams sudo = 24;
    // @gotags: validate:"omitempty"
    LpsParams lps = 25;
    GroupParams group = 26;
    LuksParams luks = 27;
    WifiParams wifi = 28;
  }
  int32 timeout_seconds = 6;
  google.protobuf.Timestamp created_at = 7;
  string created_by = 8;
  ActionSchedule schedule = 9;
  google.protobuf.Timestamp updated_at = 29;
}

message CreateActionRequest {
  // @gotags: validate:"required,min=1,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
  // @gotags: validate:"required,ne=0"
  ActionType type = 3;
  // @gotags: validate:"omitempty"
  DesiredState desired_state = 4;
  // @gotags: validate:"omitempty,gte=0,lte=3600"
  int32 timeout_seconds = 5;
  // @gotags: validate:"omitempty"
  ActionSchedule schedule = 6;

  oneof params {
    // @gotags: validate:"omitempty"
    PackageParams package = 10;
    // @gotags: validate:"omitempty"
    AppInstallParams app = 11;
    // @gotags: validate:"omitempty"
    ShellParams shell = 12;
    // @gotags: validate:"omitempty"
    SystemdParams systemd = 13;
    // @gotags: validate:"omitempty"
    FileParams file = 14;
    // @gotags: validate:"omitempty"
    UpdateParams update = 15;
    // @gotags: validate:"omitempty"
    RepositoryParams repository = 16;
    // @gotags: validate:"omitempty"
    FlatpakParams flatpak = 17;
    // @gotags: validate:"omitempty"
    DirectoryParams directory = 18;
    // @gotags: validate:"omitempty"
    UserParams user = 19;
    // @gotags: validate:"omitempty"
    SshParams ssh = 22;
    // @gotags: validate:"omitempty"
    SshdParams sshd = 23;
    // @gotags: validate:"omitempty"
    SudoParams sudo = 24;
    // @gotags: validate:"omitempty"
    LpsParams lps = 25;
    // @gotags: validate:"omitempty"
    GroupParams group = 26;
    // @gotags: validate:"omitempty"
    LuksParams luks = 27;
    // @gotags: validate:"omitempty"
    WifiParams wifi = 28;
  }
}

message CreateActionResponse {
  ManagedAction action = 1;
}

message GetActionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetActionResponse {
  ManagedAction action = 1;
}

message ListActionsRequest {
  // @gotags: validate:"omitempty,gte=0,lte=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
  ActionType type_filter = 3;
}

message ListActionsResponse {
  repeated ManagedAction actions = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message RenameActionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=255"
  string name = 2;
}

message UpdateActionDescriptionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message UpdateActionParamsRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty"
  DesiredState desired_state = 2;
  // @gotags: validate:"omitempty,gte=0,lte=3600"
  int32 timeout_seconds = 3;
  // @gotags: validate:"omitempty"
  ActionSchedule schedule = 4;

  oneof params {
    // @gotags: validate:"omitempty"
    PackageParams package = 10;
    // @gotags: validate:"omitempty"
    AppInstallParams app = 11;
    // @gotags: validate:"omitempty"
    ShellParams shell = 12;
    // @gotags: validate:"omitempty"
    SystemdParams systemd = 13;
    // @gotags: validate:"omitempty"
    FileParams file = 14;
    // @gotags: validate:"omitempty"
    UpdateParams update = 15;
    // @gotags: validate:"omitempty"
    RepositoryParams repository = 16;
    // @gotags: validate:"omitempty"
    FlatpakParams flatpak = 17;
    // @gotags: validate:"omitempty"
    DirectoryParams directory = 18;
    // @gotags: validate:"omitempty"
    UserParams user = 19;
    // @gotags: validate:"omitempty"
    SshParams ssh = 22;
    // @gotags: validate:"omitempty"
    SshdParams sshd = 23;
    // @gotags: validate:"omitempty"
    SudoParams sudo = 24;
    // @gotags: validate:"omitempty"
    LpsParams lps = 25;
    // @gotags: validate:"omitempty"
    GroupParams group = 26;
    // @gotags: validate:"omitempty"
    LuksParams luks = 27;
    // @gotags: validate:"omitempty"
    WifiParams wifi = 28;
  }
}

message UpdateActionResponse {
  ManagedAction action = 1;
}

message DeleteActionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteActionResponse {}

// ============================================================================
// Action Sets (Collection of Actions)
// ============================================================================

message ActionSet {
  string id = 1;
  string name = 2;
  string description = 3;
  int32 member_count = 4;
  google.protobuf.Timestamp created_at = 5;
  string created_by = 6;
  google.protobuf.Timestamp updated_at = 7;
}

message ActionSetMember {
  // @gotags: validate:"required,ulid"
  string action_id = 1;
  // @gotags: validate:"omitempty,gte=0"
  int32 sort_order = 2;
}

message CreateActionSetRequest {
  // @gotags: validate:"required,min=1,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message CreateActionSetResponse {
  ActionSet set = 1;
}

message GetActionSetRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetActionSetResponse {
  ActionSet set = 1;
  repeated ActionSetMember members = 2;
}

message ListActionSetsRequest {
  // @gotags: validate:"omitempty,gte=0,lte=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListActionSetsResponse {
  repeated ActionSet sets = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message RenameActionSetRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=255"
  string name = 2;
}

message UpdateActionSetDescriptionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message UpdateActionSetResponse {
  ActionSet set = 1;
}

message DeleteActionSetRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteActionSetResponse {}

message AddActionToSetRequest {
  // @gotags: validate:"required,ulid"
  string set_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
  // @gotags: validate:"omitempty,gte=0"
  int32 sort_order = 3;
}

message AddActionToSetResponse {
  ActionSet set = 1;
}

message RemoveActionFromSetRequest {
  // @gotags: validate:"required,ulid"
  string set_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
}

message RemoveActionFromSetResponse {
  ActionSet set = 1;
}

message ReorderActionInSetRequest {
  // @gotags: validate:"required,ulid"
  string set_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
  // @gotags: validate:"gte=0"
  int32 new_order = 3;
}

message ReorderActionInSetResponse {
  ActionSet set = 1;
}

// ============================================================================
// Definitions (Collection of Action Sets)
// ============================================================================

message Definition {
  string id = 1;
  string name = 2;
  string description = 3;
  int32 member_count = 4;
  google.protobuf.Timestamp created_at = 5;
  string created_by = 6;
  google.protobuf.Timestamp updated_at = 7;
}

message DefinitionMember {
  // @gotags: validate:"required,ulid"
  string action_set_id = 1;
  // @gotags: validate:"omitempty,gte=0"
  int32 sort_order = 2;
}

message CreateDefinitionRequest {
  // @gotags: validate:"required,min=1,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message CreateDefinitionResponse {
  Definition definition = 1;
}

message GetDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetDefinitionResponse {
  Definition definition = 1;
  repeated DefinitionMember members = 2;
}

message ListDefinitionsRequest {
  // @gotags: validate:"omitempty,gte=0,lte=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListDefinitionsResponse {
  repeated Definition definitions = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message RenameDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=255"
  string name = 2;
}

message UpdateDefinitionDescriptionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message UpdateDefinitionResponse {
  Definition definition = 1;
}

message DeleteDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteDefinitionResponse {}

message AddActionSetToDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string definition_id = 1;
  // @gotags: validate:"required,ulid"
  string action_set_id = 2;
  // @gotags: validate:"omitempty,gte=0"
  int32 sort_order = 3;
}

message AddActionSetToDefinitionResponse {
  Definition definition = 1;
}

message RemoveActionSetFromDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string definition_id = 1;
  // @gotags: validate:"required,ulid"
  string action_set_id = 2;
}

message RemoveActionSetFromDefinitionResponse {
  Definition definition = 1;
}

message ReorderActionSetInDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string definition_id = 1;
  // @gotags: validate:"required,ulid"
  string action_set_id = 2;
  // @gotags: validate:"gte=0"
  int32 new_order = 3;
}

message ReorderActionSetInDefinitionResponse {
  Definition definition = 1;
}

// ============================================================================
// Device Groups
// ============================================================================

message DeviceGroup {
  string id = 1;
  string name = 2;
  string description = 3;
  int32 member_count = 4;
  google.protobuf.Timestamp created_at = 5;
  string created_by = 6;
  bool is_dynamic = 7;  // True if membership is determined by dynamic_query
  string dynamic_query = 8;  // Query for dynamic membership (verbose syntax)
  // Sync interval in minutes for devices in this group (0 = use device/default)
  // Takes precedence over device-level setting
  int32 sync_interval_minutes = 9;
}

message CreateDeviceGroupRequest {
  // @gotags: validate:"required,min=1,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
  // If true, membership is determined by dynamic_query instead of manual assignment
  bool is_dynamic = 3;
  // @gotags: validate:"omitempty,max=4096"
  string dynamic_query = 4;  // Query for dynamic membership (see docs for syntax)
}

message CreateDeviceGroupResponse {
  DeviceGroup group = 1;
}

message GetDeviceGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetDeviceGroupResponse {
  DeviceGroup group = 1;
  repeated string device_ids = 2;
}

message ListDeviceGroupsRequest {
  // @gotags: validate:"omitempty,gte=0,lte=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListDeviceGroupsResponse {
  repeated DeviceGroup groups = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message RenameDeviceGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=255"
  string name = 2;
}

message UpdateDeviceGroupDescriptionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message UpdateDeviceGroupResponse {
  DeviceGroup group = 1;
}

message DeleteDeviceGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteDeviceGroupResponse {}

message AddDeviceToGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,ulid"
  string device_id = 2;
}

message AddDeviceToGroupResponse {
  DeviceGroup group = 1;
}

message RemoveDeviceFromGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,ulid"
  string device_id = 2;
}

message RemoveDeviceFromGroupResponse {
  DeviceGroup group = 1;
}

// Update a device group's dynamic query
message UpdateDeviceGroupQueryRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // If true, membership is determined by dynamic_query instead of manual assignment
  bool is_dynamic = 2;
  // @gotags: validate:"omitempty,max=4096"
  string dynamic_query = 3;  // Query for dynamic membership (see docs for syntax)
}

message UpdateDeviceGroupQueryResponse {
  DeviceGroup group = 1;
}

// Validate a dynamic query without creating a group
message ValidateDynamicQueryRequest {
  // @gotags: validate:"max=4096"
  string query = 1;
}

message ValidateDynamicQueryResponse {
  bool valid = 1;
  string error = 2;  // Error message if not valid
  int32 matching_device_count = 3;  // Number of devices that would match
}

// Trigger re-evaluation of a dynamic group
message EvaluateDynamicGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message EvaluateDynamicGroupResponse {
  DeviceGroup group = 1;
  int32 devices_added = 2;
  int32 devices_removed = 3;
}

// Update device group sync interval
message SetDeviceGroupSyncIntervalRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"gte=0,lte=1440"
  int32 sync_interval_minutes = 2;  // 0 = use device/default, max 24 hours
}

// ============================================================================
// Assignments (Link actions/sets/definitions to devices/groups)
// ============================================================================

message Assignment {
  string id = 1;
  string source_type = 2;  // "definition", "action_set", or "action"
  string source_id = 3;
  string target_type = 4;  // "device" or "device_group"
  string target_id = 5;
  google.protobuf.Timestamp created_at = 6;
  string created_by = 7;
  AssignmentMode mode = 8;
}

message CreateAssignmentRequest {
  // @gotags: validate:"required,oneof=definition action_set action"
  string source_type = 1;
  // @gotags: validate:"required,ulid"
  string source_id = 2;
  // @gotags: validate:"required,oneof=device device_group user user_group"
  string target_type = 3;
  // @gotags: validate:"required,ulid"
  string target_id = 4;
  // @gotags: validate:"omitempty"
  AssignmentMode mode = 5;  // Defaults to REQUIRED (0)
}

message CreateAssignmentResponse {
  Assignment assignment = 1;
}

message DeleteAssignmentRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteAssignmentResponse {}

message ListAssignmentsRequest {
  // @gotags: validate:"omitempty,oneof=definition action_set action"
  string source_type = 1;
  // @gotags: validate:"omitempty,ulid"
  string source_id = 2;
  // @gotags: validate:"omitempty,oneof=device device_group user user_group"
  string target_type = 3;
  // @gotags: validate:"omitempty,ulid"
  string target_id = 4;
  // @gotags: validate:"omitempty,gte=0,lte=100"
  int32 page_size = 5;
  // @gotags: validate:"omitempty"
  string page_token = 6;
}

message ListAssignmentsResponse {
  repeated Assignment assignments = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// ============================================================================
// User Selections (for available assignments)
// ============================================================================

message UserSelection {
  string id = 1;
  string device_id = 2;
  string source_type = 3;   // "action", "action_set", "definition"
  string source_id = 4;
  bool selected = 5;        // true=user wants it (present), false=user rejected (absent)
  google.protobuf.Timestamp updated_at = 6;
}

message SetUserSelectionRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,oneof=definition action_set action"
  string source_type = 2;
  // @gotags: validate:"required,ulid"
  string source_id = 3;
  bool selected = 4;
}

message SetUserSelectionResponse {
  UserSelection selection = 1;
}

message ListAvailableActionsRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message AvailableItem {
  string source_type = 1;
  string source_id = 2;
  string source_name = 3;
  string source_description = 4;
  bool selected = 5;
  repeated ManagedAction actions = 6;  // preview of contained actions
}

message ListAvailableActionsResponse {
  repeated AvailableItem items = 1;
}

// Get all resolved actions for a device (expands groups, definitions, sets)
message GetDeviceAssignmentsRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message GetDeviceAssignmentsResponse {
  repeated ManagedAction actions = 1;
  repeated ActionSet action_sets = 2;
  repeated Definition definitions = 3;
}

// Get all assignments targeting a user (directly or via user groups)
message GetUserAssignmentsRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
}

message GetUserAssignmentsResponse {
  repeated Assignment assignments = 1;
}

// ============================================================================
// Action Dispatch & Execution
// ============================================================================

message ActionExecution {
  string id = 1;
  string device_id = 2;
  string action_id = 3;  // Reference to ManagedAction
  ActionType type = 4;
  ExecutionStatus status = 5;
  string error = 6;
  CommandOutput output = 7;  // Final output (set on completion)
  google.protobuf.Timestamp created_at = 8;
  google.protobuf.Timestamp dispatched_at = 9;
  google.protobuf.Timestamp completed_at = 10;
  int64 duration_ms = 11;
  string created_by = 12;
  CommandOutput live_output = 13;  // Streaming output received so far (useful when status is RUNNING)
  DesiredState desired_state = 14;  // Whether the action was meant to install/enable (PRESENT) or remove/disable (ABSENT)
  bool changed = 15;  // Whether the execution made changes to the system (false = state was already as desired)
  bool compliant = 16;  // Detection script result: true if compliant
  CommandOutput detection_output = 17;  // Detection script output
  string action_name = 18;  // Resolved from actions_projection (empty for inline actions)
}

message DispatchActionRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // Either use an action or inline action
  oneof action_source {
    // @gotags: validate:"omitempty,ulid"
    string action_id = 2;  // Reference to ManagedAction
    Action inline_action = 3;
  }
}

message DispatchActionResponse {
  ActionExecution execution = 1;
}

message DispatchToMultipleRequest {
  // @gotags: validate:"required,min=1,dive,ulid"
  repeated string device_ids = 1;
  oneof action_source {
    // @gotags: validate:"omitempty,ulid"
    string action_id = 2;  // Reference to ManagedAction
    Action inline_action = 3;
  }
}

message DispatchToMultipleResponse {
  repeated ActionExecution executions = 1;
}

// Dispatch all actions assigned to a device (resolves definitions, sets, groups)
message DispatchAssignedActionsRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message DispatchAssignedActionsResponse {
  repeated ActionExecution executions = 1;
}

// Dispatch all actions from an action set to a device
message DispatchActionSetRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,ulid"
  string action_set_id = 2;
}

message DispatchActionSetResponse {
  repeated ActionExecution executions = 1;
}

// Dispatch all actions from a definition to a device
message DispatchDefinitionRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,ulid"
  string definition_id = 2;
}

message DispatchDefinitionResponse {
  repeated ActionExecution executions = 1;
}

// Dispatch to a device group
message DispatchToGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  oneof action_source {
    // @gotags: validate:"omitempty,ulid"
    string action_id = 2;
    // @gotags: validate:"omitempty,ulid"
    string action_set_id = 3;
    // @gotags: validate:"omitempty,ulid"
    string definition_id = 4;
    Action inline_action = 5;
  }
}

message DispatchToGroupResponse {
  repeated ActionExecution executions = 1;
}

message GetExecutionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetExecutionResponse {
  ActionExecution execution = 1;
}

message ListExecutionsRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
  // @gotags: validate:"omitempty,ulid"
  string device_id = 3;  // optional filter
  ExecutionStatus status_filter = 4;
  ActionType type_filter = 5;  // optional action type filter
  string search = 6;           // searches action name and device hostname
}

message ListExecutionsResponse {
  repeated ActionExecution executions = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// ============================================================================
// Instant Actions (agent-builtin, no parameters)
// ============================================================================

message DispatchInstantActionRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,ne=0"
  ActionType instant_action = 2;
}

message DispatchInstantActionResponse {
  ActionExecution execution = 1;
}

// ============================================================================
// Audit Log
// ============================================================================

message AuditEvent {
  string id = 1;
  string event_type = 2;
  string stream_type = 3;
  string stream_id = 4;
  string actor_type = 5;
  string actor_id = 6;
  string data = 7;
  google.protobuf.Timestamp occurred_at = 8;
}

message ListAuditEventsRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
  // @gotags: validate:"omitempty"
  string actor_id = 3;
  // @gotags: validate:"omitempty"
  string stream_type = 4;
  // @gotags: validate:"omitempty"
  string event_type = 5;
}

message ListAuditEventsResponse {
  repeated AuditEvent events = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

// ============================================================================
// LPS (Local Password Solution)
// ============================================================================

// LPS password entry stored per device
message LpsPassword {
  string device_id = 1;
  string device_hostname = 2;
  string action_id = 3;
  string action_name = 4;
  string username = 5;
  string password = 6;
  google.protobuf.Timestamp rotated_at = 7;
  string rotation_reason = 8;
}

message GetDeviceLpsPasswordsRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message GetDeviceLpsPasswordsResponse {
  // Current passwords (one per LPS action assigned to device)
  repeated LpsPassword current = 1;
  // Previous passwords (most recent first, max 3 per action)
  repeated LpsPassword history = 2;
}

// ============================================================================
// LUKS (Disk Encryption)
// ============================================================================

// LUKS key entry stored per device
message LuksKey {
  string device_id = 1;
  string device_hostname = 2;
  string action_id = 3;
  string action_name = 4;
  string device_path = 5;
  string passphrase = 6;
  google.protobuf.Timestamp rotated_at = 7;
  string rotation_reason = 8;
  // Revocation status: "" (none), "dispatched", "success", "failed"
  string revocation_status = 9;
  // Error message if revocation failed
  string revocation_error = 10;
  // Timestamp of last revocation event
  google.protobuf.Timestamp revocation_at = 11;
}

message GetDeviceLuksKeysRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message GetDeviceLuksKeysResponse {
  // Current keys (one per LUKS action assigned to device)
  repeated LuksKey current = 1;
  // Previous keys (most recent first, max 3 per action)
  repeated LuksKey history = 2;
}

message CreateLuksTokenRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
}

message CreateLuksTokenResponse {
  // One-time UUID token
  string token = 1;
  // URI for opening terminal: power-manage://luks/set-passphrase?token=XXX
  string uri = 2;
  // CLI command: power-manage-agent luks set-passphrase --token XXX
  string cli_command = 3;
}

message RevokeLuksDeviceKeyRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
}

message RevokeLuksDeviceKeyResponse {}

// ============================================================================
// OSQuery / Device Inventory
// ============================================================================

// Dispatch an on-demand OSQuery to a connected device
message DispatchOSQueryRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // @gotags: validate:"required_without=RawSql,omitempty,min=1,max=64"
  string table = 2;
  // @gotags: validate:"omitempty,dive,max=64"
  repeated string columns = 3;
  // @gotags: validate:"omitempty,gte=0,lte=10000"
  int32 limit = 4;
  // Raw SQL query — when set, table/columns/limit are ignored.
  // @gotags: validate:"omitempty,max=4096"
  string raw_sql = 5;
}

message DispatchOSQueryResponse {
  string query_id = 1;
}

// Poll for the result of a dispatched OSQuery
message GetOSQueryResultRequest {
  // @gotags: validate:"required,ulid"
  string query_id = 1;
}

message GetOSQueryResultResponse {
  string query_id = 1;
  bool completed = 2;
  bool success = 3;
  string error = 4;
  repeated OSQueryRow rows = 5;
}

// Get cached device inventory (hardware/software data collected by agent)
message GetDeviceInventoryRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
  // Optional: filter to specific tables (empty = all)
  repeated string table_names = 2;
}

message InventoryTableResult {
  string table_name = 1;
  repeated OSQueryRow rows = 2;
  google.protobuf.Timestamp collected_at = 3;
}

message GetDeviceInventoryResponse {
  repeated InventoryTableResult tables = 1;
}

// Request the agent to re-collect and send inventory
message RefreshDeviceInventoryRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message RefreshDeviceInventoryResponse {}

// ============================================================================
// Roles & Permissions
// ============================================================================

message CreateRoleRequest {
  // @gotags: validate:"required,min=1,max=64"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
  // @gotags: validate:"omitempty"
  repeated string permissions = 3;
}

message CreateRoleResponse {
  Role role = 1;
}

message GetRoleRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetRoleResponse {
  Role role = 1;
  int32 user_count = 2;
}

message ListRolesRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListRolesResponse {
  repeated Role roles = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message UpdateRoleRequest {
  // @gotags: validate:"required,ulid"
  string role_id = 1;
  // @gotags: validate:"required,min=1,max=64"
  string name = 2;
  // @gotags: validate:"omitempty,max=1024"
  string description = 3;
  // @gotags: validate:"required,min=1"
  repeated string permissions = 4;
}

message UpdateRoleResponse {
  Role role = 1;
}

message DeleteRoleRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteRoleResponse {}

message AssignRoleToUserRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  // @gotags: validate:"required,ulid"
  string role_id = 2;
}

message AssignRoleToUserResponse {}

message RevokeRoleFromUserRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  // @gotags: validate:"required,ulid"
  string role_id = 2;
}

message RevokeRoleFromUserResponse {}

message ListPermissionsRequest {}

message ListPermissionsResponse {
  repeated PermissionInfo permissions = 1;
}

// ============================================================================
// User Groups
// ============================================================================

message UserGroup {
  string id = 1;
  string name = 2;
  string description = 3;
  int32 member_count = 4;
  repeated Role roles = 5;
  google.protobuf.Timestamp created_at = 6;
  bool is_dynamic = 7;
  string dynamic_query = 8;
  bool is_scim_managed = 9;
}

message UserGroupMember {
  string user_id = 1;
  string email = 2;
  google.protobuf.Timestamp added_at = 3;
}

message CreateUserGroupRequest {
  // @gotags: validate:"required,min=1,max=64"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
  bool is_dynamic = 3;
  // @gotags: validate:"omitempty,max=4096"
  string dynamic_query = 4;
}

message CreateUserGroupResponse {
  UserGroup group = 1;
}

message GetUserGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetUserGroupResponse {
  UserGroup group = 1;
  repeated UserGroupMember members = 2;
}

message ListUserGroupsRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListUserGroupsResponse {
  repeated UserGroup groups = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message UpdateUserGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,min=1,max=64"
  string name = 2;
  // @gotags: validate:"omitempty,max=1024"
  string description = 3;
}

message UpdateUserGroupResponse {
  UserGroup group = 1;
}

message DeleteUserGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteUserGroupResponse {}

message AddUserToGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,ulid"
  string user_id = 2;
}

message AddUserToGroupResponse {}

message RemoveUserFromGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,ulid"
  string user_id = 2;
}

message RemoveUserFromGroupResponse {}

message AssignRoleToUserGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,ulid"
  string role_id = 2;
}

message AssignRoleToUserGroupResponse {}

message RevokeRoleFromUserGroupRequest {
  // @gotags: validate:"required,ulid"
  string group_id = 1;
  // @gotags: validate:"required,ulid"
  string role_id = 2;
}

message RevokeRoleFromUserGroupResponse {}

message ListUserGroupsForUserRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
}

message ListUserGroupsForUserResponse {
  repeated UserGroup groups = 1;
}

message UpdateUserGroupQueryRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  bool is_dynamic = 2;
  // @gotags: validate:"omitempty,max=4096"
  string dynamic_query = 3;
}

message UpdateUserGroupQueryResponse {
  UserGroup group = 1;
}

message ValidateUserGroupQueryRequest {
  // @gotags: validate:"max=4096"
  string query = 1;
}

message ValidateUserGroupQueryResponse {
  bool valid = 1;
  string error = 2;
  int32 matching_user_count = 3;
}

message EvaluateDynamicUserGroupRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message EvaluateDynamicUserGroupResponse {
  UserGroup group = 1;
  int32 users_added = 2;
  int32 users_removed = 3;
}

// ============================================================================
// Identity Providers (OIDC SSO)
// ============================================================================

message IdentityProvider {
  string id = 1;
  string name = 2;
  string slug = 3;
  string provider_type = 4;  // "oidc"
  bool enabled = 5;
  string client_id = 6;
  // client_secret is not returned in responses (write-only).
  string issuer_url = 7;
  string authorization_url = 8;
  string token_url = 9;
  string userinfo_url = 10;
  repeated string scopes = 11;
  bool auto_create_users = 12;
  bool auto_link_by_email = 13;
  string default_role_id = 14;
  bool disable_password_for_linked = 15;
  string group_claim = 16;
  map<string, string> group_mapping = 17;  // external group name → user_group_id
  google.protobuf.Timestamp created_at = 18;
  google.protobuf.Timestamp updated_at = 19;
  bool scim_enabled = 20;
  string scim_endpoint_url = 21;  // read-only, computed by server
}

message IdentityLink {
  string id = 1;
  string user_id = 2;
  string provider_id = 3;
  string provider_name = 4;
  string provider_slug = 5;
  string external_id = 6;
  string external_email = 7;
  string external_name = 8;
  google.protobuf.Timestamp linked_at = 9;
  google.protobuf.Timestamp last_login_at = 10;
}

message CreateIdentityProviderRequest {
  // @gotags: validate:"required,min=1,max=64"
  string name = 1;
  // @gotags: validate:"required,min=1,max=64,alphanum"
  string slug = 2;
  // @gotags: validate:"required,oneof=oidc"
  string provider_type = 3;
  // @gotags: validate:"required,min=1"
  string client_id = 4;
  // @gotags: validate:"required,min=1"
  string client_secret = 5;
  // @gotags: validate:"required,url"
  string issuer_url = 6;
  string authorization_url = 7;
  string token_url = 8;
  string userinfo_url = 9;
  repeated string scopes = 10;
  bool auto_create_users = 11;
  bool auto_link_by_email = 12;
  string default_role_id = 13;
  bool disable_password_for_linked = 14;
  string group_claim = 15;
  map<string, string> group_mapping = 16;
}

message CreateIdentityProviderResponse {
  IdentityProvider provider = 1;
}

message GetIdentityProviderRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetIdentityProviderResponse {
  IdentityProvider provider = 1;
}

message ListIdentityProvidersRequest {
  // @gotags: validate:"omitempty,min=1,max=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListIdentityProvidersResponse {
  repeated IdentityProvider providers = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message UpdateIdentityProviderRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=64"
  string name = 2;
  bool enabled = 3;
  string client_id = 4;
  // If empty, the existing secret is kept.
  string client_secret = 5;
  string issuer_url = 6;
  string authorization_url = 7;
  string token_url = 8;
  string userinfo_url = 9;
  repeated string scopes = 10;
  bool auto_create_users = 11;
  bool auto_link_by_email = 12;
  string default_role_id = 13;
  bool disable_password_for_linked = 14;
  string group_claim = 15;
  map<string, string> group_mapping = 16;
}

message UpdateIdentityProviderResponse {
  IdentityProvider provider = 1;
}

message DeleteIdentityProviderRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteIdentityProviderResponse {}

// ============================================================================
// SSO Authentication Flow
// ============================================================================

message AuthMethodProvider {
  string slug = 1;
  string name = 2;
  string provider_type = 3;
}

message ListAuthMethodsRequest {
  // Optional email to check user-specific auth methods.
  string email = 1;
}

message ListAuthMethodsResponse {
  bool password_enabled = 1;
  bool totp_enabled = 2;
  repeated AuthMethodProvider providers = 3;
}

message GetSSOLoginURLRequest {
  // @gotags: validate:"required,min=1,max=64"
  string slug = 1;
  // @gotags: validate:"required,url"
  string redirect_url = 2;
}

message GetSSOLoginURLResponse {
  string login_url = 1;
}

message SSOCallbackRequest {
  // @gotags: validate:"required,min=1,max=64"
  string slug = 1;
  // @gotags: validate:"required"
  string code = 2;
  // @gotags: validate:"required"
  string state = 3;
}

message SSOCallbackResponse {
  string access_token = 1;
  string refresh_token = 2;
  google.protobuf.Timestamp expires_at = 3;
  User user = 4;
  // When true, TOTP verification is required before tokens are issued.
  bool totp_required = 5;
  string totp_challenge = 6;
}

// ============================================================================
// Identity Linking (Self-Service)
// ============================================================================

message ListIdentityLinksRequest {}

message ListIdentityLinksResponse {
  repeated IdentityLink links = 1;
}

message UnlinkIdentityRequest {
  // @gotags: validate:"required,ulid"
  string link_id = 1;
}

message UnlinkIdentityResponse {}

// SCIM Provisioning
message EnableSCIMRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message EnableSCIMResponse {
  string token = 1;        // plaintext token, shown once
  string endpoint_url = 2; // full SCIM endpoint URL
}

message DisableSCIMRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DisableSCIMResponse {}

message RotateSCIMTokenRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message RotateSCIMTokenResponse {
  string token = 1; // new plaintext token, shown once
}

// ============================================================================
// Device Authentication (PAM/NSS device login)
// ============================================================================

message AuthenticateDeviceUserRequest {
  // @gotags: validate:"required"
  string device_id = 1;        // Which device is being logged into
  // @gotags: validate:"required,min=1,max=254"
  string username = 2;         // PM email or username
  string password = 3;         // PM password (empty = probe for auth method)
  string totp_code = 4;        // Optional TOTP 2FA code
}

message AuthenticateDeviceUserResponse {
  bool success = 1;
  bool password_required = 2;  // User has PM password, prompt for it
  bool oidc_required = 3;      // User is OIDC-only, needs browser flow
  bool totp_required = 4;      // TOTP 2FA needed, prompt for code
  string error = 5;
  DeviceUserInfo user = 6;     // User metadata (populated on success)
  string session_token = 7;    // Cached for sudo re-auth
  int64 session_ttl_seconds = 8;
}

message DeviceUserInfo {
  string username = 1;         // Local Linux username
  uint32 uid = 2;              // Assigned UID (from PM range, e.g. 60000-64999)
  uint32 gid = 3;              // Primary GID
  string home_dir = 4;         // e.g., /home/username
  string shell = 5;            // e.g., /bin/bash
  repeated string groups = 6;  // Supplementary group names
  string gecos = 7;            // Full name (GECOS field)
}

message GetDeviceLoginURLRequest {
  // @gotags: validate:"required"
  string device_id = 1;
  // @gotags: validate:"required,min=1,max=65535"
  int32 callback_port = 2;     // localhost port PAM is listening on
  string username = 3;         // Pre-fill email on login page
}

message GetDeviceLoginURLResponse {
  string login_url = 1;        // Full URL to open in browser
}

message DeviceLoginCallbackRequest {
  // @gotags: validate:"required"
  string callback_token = 1;   // Token from browser redirect
  // @gotags: validate:"required"
  string device_id = 2;
}

message DeviceLoginCallbackResponse {
  bool success = 1;
  string error = 2;
  DeviceUserInfo user = 3;
  string session_token = 4;
  int64 session_ttl_seconds = 5;
}

message ListDeviceUsersRequest {
  // @gotags: validate:"required"
  string device_id = 1;
}

message ListDeviceUsersResponse {
  repeated DeviceUserInfo users = 1;
}

// ============================================================================
// Device Compliance
// ============================================================================

message GetDeviceComplianceRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message GetDeviceComplianceResponse {
  ComplianceStatus status = 1;
  repeated ComplianceCheckResult checks = 2;
}

message ComplianceCheckResult {
  string action_id = 1;
  string action_name = 2;
  bool compliant = 3;
  CommandOutput detection_output = 4;
  google.protobuf.Timestamp checked_at = 5;
}

// ============================================================================
// Compliance Policies
// ============================================================================

message CompliancePolicy {
  string id = 1;
  string name = 2;
  string description = 3;
  repeated CompliancePolicyRule rules = 4;
  int32 rule_count = 5;
  google.protobuf.Timestamp created_at = 6;
  string created_by = 7;
}

message CompliancePolicyRule {
  string action_id = 1;
  string action_name = 2;
  int32 grace_period_hours = 3;
}

message CreateCompliancePolicyRequest {
  // @gotags: validate:"required,min=1,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message CreateCompliancePolicyResponse {
  CompliancePolicy policy = 1;
}

message GetCompliancePolicyRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message GetCompliancePolicyResponse {
  CompliancePolicy policy = 1;
}

message ListCompliancePoliciesRequest {
  // @gotags: validate:"omitempty,gte=0,lte=100"
  int32 page_size = 1;
  // @gotags: validate:"omitempty"
  string page_token = 2;
}

message ListCompliancePoliciesResponse {
  repeated CompliancePolicy policies = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message RenameCompliancePolicyRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"required,min=1,max=255"
  string name = 2;
}

message UpdateCompliancePolicyDescriptionRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
  // @gotags: validate:"omitempty,max=1024"
  string description = 2;
}

message UpdateCompliancePolicyResponse {
  CompliancePolicy policy = 1;
}

message DeleteCompliancePolicyRequest {
  // @gotags: validate:"required,ulid"
  string id = 1;
}

message DeleteCompliancePolicyResponse {}

message AddCompliancePolicyRuleRequest {
  // @gotags: validate:"required,ulid"
  string policy_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
  // @gotags: validate:"omitempty,gte=0,lte=8760"
  int32 grace_period_hours = 3;
}

message AddCompliancePolicyRuleResponse {
  CompliancePolicy policy = 1;
}

message RemoveCompliancePolicyRuleRequest {
  // @gotags: validate:"required,ulid"
  string policy_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
}

message RemoveCompliancePolicyRuleResponse {
  CompliancePolicy policy = 1;
}

message UpdateCompliancePolicyRuleRequest {
  // @gotags: validate:"required,ulid"
  string policy_id = 1;
  // @gotags: validate:"required,ulid"
  string action_id = 2;
  // @gotags: validate:"omitempty,gte=0,lte=8760"
  int32 grace_period_hours = 3;
}

message UpdateCompliancePolicyRuleResponse {
  CompliancePolicy policy = 1;
}

message GetDeviceCompliancePolicyStatusRequest {
  // @gotags: validate:"required,ulid"
  string device_id = 1;
}

message GetDeviceCompliancePolicyStatusResponse {
  ComplianceStatus overall_status = 1;
  repeated DevicePolicyEvaluation policies = 2;
}

message DevicePolicyEvaluation {
  string policy_id = 1;
  string policy_name = 2;
  ComplianceStatus status = 3;
  repeated DevicePolicyRuleEvaluation rules = 4;
}

message DevicePolicyRuleEvaluation {
  string action_id = 1;
  string action_name = 2;
  ComplianceStatus status = 3;
  bool compliant = 4;
  google.protobuf.Timestamp checked_at = 5;
  google.protobuf.Timestamp first_failed_at = 6;
  int32 grace_period_hours = 7;
  google.protobuf.Timestamp grace_expires_at = 8;
  CommandOutput detection_output = 9;
}

// ============================================================================
// Search
// ============================================================================

message SearchRequest {
  string query = 1;
  string scope = 2; // "actions", "action_sets", "definitions", or "" for all
  int32 page_size = 3;
  string page_token = 4;
}

message SearchResult {
  string id = 1;
  string name = 2;
  string description = 3;
  string scope = 4;
  int32 member_count = 5;
}

message SearchResponse {
  repeated SearchResult results = 1;
  string next_page_token = 2;
  int32 total_count = 3;
}

message RebuildSearchIndexRequest {}
message RebuildSearchIndexResponse {}

// ============================================================================
// Server Settings
// ============================================================================

message ServerSettings {
  bool user_provisioning_enabled = 1;
  bool ssh_access_for_all = 2;
}

message GetServerSettingsRequest {}
message GetServerSettingsResponse {
  ServerSettings settings = 1;
}

message UpdateServerSettingsRequest {
  bool user_provisioning_enabled = 1;
  bool ssh_access_for_all = 2;
}
message UpdateServerSettingsResponse {
  ServerSettings settings = 1;
}

// ============================================================================
// User Provisioning Per-User
// ============================================================================

message SetUserProvisioningEnabledRequest {
  // @gotags: validate:"required,ulid"
  string user_id = 1;
  bool enabled = 2;
}

// ============================================================================
// Service Definition
// ============================================================================

service ControlService {
  // Agent Registration
  rpc Register(RegisterRequest) returns (RegisterResponse);

  // Certificate Renewal
  rpc RenewCertificate(RenewCertificateRequest) returns (RenewCertificateResponse);

  // Authentication
  rpc Login(LoginRequest) returns (LoginResponse);
  rpc RefreshToken(RefreshTokenRequest) returns (RefreshTokenResponse);
  rpc Logout(LogoutRequest) returns (LogoutResponse);
  rpc GetCurrentUser(GetCurrentUserRequest) returns (GetCurrentUserResponse);
  rpc VerifyLoginTOTP(VerifyLoginTOTPRequest) returns (VerifyLoginTOTPResponse);

  // TOTP Two-Factor Authentication
  rpc SetupTOTP(SetupTOTPRequest) returns (SetupTOTPResponse);
  rpc VerifyTOTP(VerifyTOTPRequest) returns (VerifyTOTPResponse);
  rpc DisableTOTP(DisableTOTPRequest) returns (DisableTOTPResponse);
  rpc AdminDisableUserTOTP(AdminDisableUserTOTPRequest) returns (AdminDisableUserTOTPResponse);
  rpc GetTOTPStatus(GetTOTPStatusRequest) returns (GetTOTPStatusResponse);
  rpc RegenerateBackupCodes(RegenerateBackupCodesRequest) returns (RegenerateBackupCodesResponse);

  // SSO / Identity Providers
  rpc ListAuthMethods(ListAuthMethodsRequest) returns (ListAuthMethodsResponse);
  rpc GetSSOLoginURL(GetSSOLoginURLRequest) returns (GetSSOLoginURLResponse);
  rpc SSOCallback(SSOCallbackRequest) returns (SSOCallbackResponse);
  rpc CreateIdentityProvider(CreateIdentityProviderRequest) returns (CreateIdentityProviderResponse);
  rpc GetIdentityProvider(GetIdentityProviderRequest) returns (GetIdentityProviderResponse);
  rpc ListIdentityProviders(ListIdentityProvidersRequest) returns (ListIdentityProvidersResponse);
  rpc UpdateIdentityProvider(UpdateIdentityProviderRequest) returns (UpdateIdentityProviderResponse);
  rpc DeleteIdentityProvider(DeleteIdentityProviderRequest) returns (DeleteIdentityProviderResponse);
  rpc ListIdentityLinks(ListIdentityLinksRequest) returns (ListIdentityLinksResponse);
  rpc UnlinkIdentity(UnlinkIdentityRequest) returns (UnlinkIdentityResponse);

  // SCIM Provisioning
  rpc EnableSCIM(EnableSCIMRequest) returns (EnableSCIMResponse);
  rpc DisableSCIM(DisableSCIMRequest) returns (DisableSCIMResponse);
  rpc RotateSCIMToken(RotateSCIMTokenRequest) returns (RotateSCIMTokenResponse);

  // Users
  rpc CreateUser(CreateUserRequest) returns (CreateUserResponse);
  rpc GetUser(GetUserRequest) returns (GetUserResponse);
  rpc ListUsers(ListUsersRequest) returns (ListUsersResponse);
  rpc UpdateUserEmail(UpdateUserEmailRequest) returns (UpdateUserResponse);
  rpc UpdateUserPassword(UpdateUserPasswordRequest) returns (UpdateUserResponse);
  rpc SetUserDisabled(SetUserDisabledRequest) returns (UpdateUserResponse);
  rpc UpdateUserProfile(UpdateUserProfileRequest) returns (UpdateUserResponse);
  rpc UpdateUserLinuxUsername(UpdateUserLinuxUsernameRequest) returns (UpdateUserResponse);
  rpc AddUserSshKey(AddUserSshKeyRequest) returns (AddUserSshKeyResponse);
  rpc RemoveUserSshKey(RemoveUserSshKeyRequest) returns (RemoveUserSshKeyResponse);
  rpc UpdateUserSshSettings(UpdateUserSshSettingsRequest) returns (UpdateUserResponse);
  rpc DeleteUser(DeleteUserRequest) returns (DeleteUserResponse);

  // Devices
  rpc ListDevices(ListDevicesRequest) returns (ListDevicesResponse);
  rpc GetDevice(GetDeviceRequest) returns (GetDeviceResponse);
  rpc SetDeviceLabel(SetDeviceLabelRequest) returns (UpdateDeviceResponse);
  rpc RemoveDeviceLabel(RemoveDeviceLabelRequest) returns (UpdateDeviceResponse);
  rpc AssignDevice(AssignDeviceRequest) returns (AssignDeviceResponse);
  rpc UnassignDevice(UnassignDeviceRequest) returns (UnassignDeviceResponse);
  rpc SetDeviceSyncInterval(SetDeviceSyncIntervalRequest) returns (UpdateDeviceResponse);
  rpc DeleteDevice(DeleteDeviceRequest) returns (DeleteDeviceResponse);

  // Registration Tokens
  rpc CreateToken(CreateTokenRequest) returns (CreateTokenResponse);
  rpc GetToken(GetTokenRequest) returns (GetTokenResponse);
  rpc ListTokens(ListTokensRequest) returns (ListTokensResponse);
  rpc RenameToken(RenameTokenRequest) returns (UpdateTokenResponse);
  rpc SetTokenDisabled(SetTokenDisabledRequest) returns (UpdateTokenResponse);
  rpc DeleteToken(DeleteTokenRequest) returns (DeleteTokenResponse);

  // Actions (single executable)
  rpc CreateAction(CreateActionRequest) returns (CreateActionResponse);
  rpc GetAction(GetActionRequest) returns (GetActionResponse);
  rpc ListActions(ListActionsRequest) returns (ListActionsResponse);
  rpc RenameAction(RenameActionRequest) returns (UpdateActionResponse);
  rpc UpdateActionDescription(UpdateActionDescriptionRequest) returns (UpdateActionResponse);
  rpc UpdateActionParams(UpdateActionParamsRequest) returns (UpdateActionResponse);
  rpc DeleteAction(DeleteActionRequest) returns (DeleteActionResponse);

  // Action Sets (collection of actions)
  rpc CreateActionSet(CreateActionSetRequest) returns (CreateActionSetResponse);
  rpc GetActionSet(GetActionSetRequest) returns (GetActionSetResponse);
  rpc ListActionSets(ListActionSetsRequest) returns (ListActionSetsResponse);
  rpc RenameActionSet(RenameActionSetRequest) returns (UpdateActionSetResponse);
  rpc UpdateActionSetDescription(UpdateActionSetDescriptionRequest) returns (UpdateActionSetResponse);
  rpc DeleteActionSet(DeleteActionSetRequest) returns (DeleteActionSetResponse);
  rpc AddActionToSet(AddActionToSetRequest) returns (AddActionToSetResponse);
  rpc RemoveActionFromSet(RemoveActionFromSetRequest) returns (RemoveActionFromSetResponse);
  rpc ReorderActionInSet(ReorderActionInSetRequest) returns (ReorderActionInSetResponse);

  // Definitions (collection of action sets)
  rpc CreateDefinition(CreateDefinitionRequest) returns (CreateDefinitionResponse);
  rpc GetDefinition(GetDefinitionRequest) returns (GetDefinitionResponse);
  rpc ListDefinitions(ListDefinitionsRequest) returns (ListDefinitionsResponse);
  rpc RenameDefinition(RenameDefinitionRequest) returns (UpdateDefinitionResponse);
  rpc UpdateDefinitionDescription(UpdateDefinitionDescriptionRequest) returns (UpdateDefinitionResponse);
  rpc DeleteDefinition(DeleteDefinitionRequest) returns (DeleteDefinitionResponse);
  rpc AddActionSetToDefinition(AddActionSetToDefinitionRequest) returns (AddActionSetToDefinitionResponse);
  rpc RemoveActionSetFromDefinition(RemoveActionSetFromDefinitionRequest) returns (RemoveActionSetFromDefinitionResponse);
  rpc ReorderActionSetInDefinition(ReorderActionSetInDefinitionRequest) returns (ReorderActionSetInDefinitionResponse);

  // Device Groups
  rpc CreateDeviceGroup(CreateDeviceGroupRequest) returns (CreateDeviceGroupResponse);
  rpc GetDeviceGroup(GetDeviceGroupRequest) returns (GetDeviceGroupResponse);
  rpc ListDeviceGroups(ListDeviceGroupsRequest) returns (ListDeviceGroupsResponse);
  rpc RenameDeviceGroup(RenameDeviceGroupRequest) returns (UpdateDeviceGroupResponse);
  rpc UpdateDeviceGroupDescription(UpdateDeviceGroupDescriptionRequest) returns (UpdateDeviceGroupResponse);
  rpc UpdateDeviceGroupQuery(UpdateDeviceGroupQueryRequest) returns (UpdateDeviceGroupQueryResponse);
  rpc DeleteDeviceGroup(DeleteDeviceGroupRequest) returns (DeleteDeviceGroupResponse);
  rpc AddDeviceToGroup(AddDeviceToGroupRequest) returns (AddDeviceToGroupResponse);
  rpc RemoveDeviceFromGroup(RemoveDeviceFromGroupRequest) returns (RemoveDeviceFromGroupResponse);
  rpc ValidateDynamicQuery(ValidateDynamicQueryRequest) returns (ValidateDynamicQueryResponse);
  rpc EvaluateDynamicGroup(EvaluateDynamicGroupRequest) returns (EvaluateDynamicGroupResponse);
  rpc SetDeviceGroupSyncInterval(SetDeviceGroupSyncIntervalRequest) returns (UpdateDeviceGroupResponse);

  // Assignments
  rpc CreateAssignment(CreateAssignmentRequest) returns (CreateAssignmentResponse);
  rpc DeleteAssignment(DeleteAssignmentRequest) returns (DeleteAssignmentResponse);
  rpc ListAssignments(ListAssignmentsRequest) returns (ListAssignmentsResponse);
  rpc GetDeviceAssignments(GetDeviceAssignmentsRequest) returns (GetDeviceAssignmentsResponse);
  rpc GetUserAssignments(GetUserAssignmentsRequest) returns (GetUserAssignmentsResponse);

  // User Selections (for available assignments)
  rpc SetUserSelection(SetUserSelectionRequest) returns (SetUserSelectionResponse);
  rpc ListAvailableActions(ListAvailableActionsRequest) returns (ListAvailableActionsResponse);

  // Action Dispatch & Execution
  rpc DispatchAction(DispatchActionRequest) returns (DispatchActionResponse);
  rpc DispatchToMultiple(DispatchToMultipleRequest) returns (DispatchToMultipleResponse);
  rpc DispatchAssignedActions(DispatchAssignedActionsRequest) returns (DispatchAssignedActionsResponse);
  rpc DispatchActionSet(DispatchActionSetRequest) returns (DispatchActionSetResponse);
  rpc DispatchDefinition(DispatchDefinitionRequest) returns (DispatchDefinitionResponse);
  rpc DispatchToGroup(DispatchToGroupRequest) returns (DispatchToGroupResponse);
  rpc DispatchInstantAction(DispatchInstantActionRequest) returns (DispatchInstantActionResponse);
  rpc GetExecution(GetExecutionRequest) returns (GetExecutionResponse);
  rpc ListExecutions(ListExecutionsRequest) returns (ListExecutionsResponse);

  // Audit Log
  rpc ListAuditEvents(ListAuditEventsRequest) returns (ListAuditEventsResponse);

  // LPS (Local Password Solution)
  rpc GetDeviceLpsPasswords(GetDeviceLpsPasswordsRequest) returns (GetDeviceLpsPasswordsResponse);

  // LUKS (Disk Encryption)
  rpc GetDeviceLuksKeys(GetDeviceLuksKeysRequest) returns (GetDeviceLuksKeysResponse);
  rpc CreateLuksToken(CreateLuksTokenRequest) returns (CreateLuksTokenResponse);
  rpc RevokeLuksDeviceKey(RevokeLuksDeviceKeyRequest) returns (RevokeLuksDeviceKeyResponse);

  // OSQuery / Device Inventory
  rpc DispatchOSQuery(DispatchOSQueryRequest) returns (DispatchOSQueryResponse);
  rpc GetOSQueryResult(GetOSQueryResultRequest) returns (GetOSQueryResultResponse);
  rpc GetDeviceInventory(GetDeviceInventoryRequest) returns (GetDeviceInventoryResponse);
  rpc RefreshDeviceInventory(RefreshDeviceInventoryRequest) returns (RefreshDeviceInventoryResponse);

  // Roles & Permissions
  rpc CreateRole(CreateRoleRequest) returns (CreateRoleResponse);
  rpc GetRole(GetRoleRequest) returns (GetRoleResponse);
  rpc ListRoles(ListRolesRequest) returns (ListRolesResponse);
  rpc UpdateRole(UpdateRoleRequest) returns (UpdateRoleResponse);
  rpc DeleteRole(DeleteRoleRequest) returns (DeleteRoleResponse);
  rpc AssignRoleToUser(AssignRoleToUserRequest) returns (AssignRoleToUserResponse);
  rpc RevokeRoleFromUser(RevokeRoleFromUserRequest) returns (RevokeRoleFromUserResponse);
  rpc ListPermissions(ListPermissionsRequest) returns (ListPermissionsResponse);

  // User Groups
  rpc CreateUserGroup(CreateUserGroupRequest) returns (CreateUserGroupResponse);
  rpc GetUserGroup(GetUserGroupRequest) returns (GetUserGroupResponse);
  rpc ListUserGroups(ListUserGroupsRequest) returns (ListUserGroupsResponse);
  rpc UpdateUserGroup(UpdateUserGroupRequest) returns (UpdateUserGroupResponse);
  rpc DeleteUserGroup(DeleteUserGroupRequest) returns (DeleteUserGroupResponse);
  rpc AddUserToGroup(AddUserToGroupRequest) returns (AddUserToGroupResponse);
  rpc RemoveUserFromGroup(RemoveUserFromGroupRequest) returns (RemoveUserFromGroupResponse);
  rpc AssignRoleToUserGroup(AssignRoleToUserGroupRequest) returns (AssignRoleToUserGroupResponse);
  rpc RevokeRoleFromUserGroup(RevokeRoleFromUserGroupRequest) returns (RevokeRoleFromUserGroupResponse);
  rpc ListUserGroupsForUser(ListUserGroupsForUserRequest) returns (ListUserGroupsForUserResponse);
  rpc UpdateUserGroupQuery(UpdateUserGroupQueryRequest) returns (UpdateUserGroupQueryResponse);
  rpc ValidateUserGroupQuery(ValidateUserGroupQueryRequest) returns (ValidateUserGroupQueryResponse);
  rpc EvaluateDynamicUserGroup(EvaluateDynamicUserGroupRequest) returns (EvaluateDynamicUserGroupResponse);

  // Device Compliance
  rpc GetDeviceCompliance(GetDeviceComplianceRequest) returns (GetDeviceComplianceResponse);

  // Compliance Policies
  rpc CreateCompliancePolicy(CreateCompliancePolicyRequest) returns (CreateCompliancePolicyResponse);
  rpc GetCompliancePolicy(GetCompliancePolicyRequest) returns (GetCompliancePolicyResponse);
  rpc ListCompliancePolicies(ListCompliancePoliciesRequest) returns (ListCompliancePoliciesResponse);
  rpc RenameCompliancePolicy(RenameCompliancePolicyRequest) returns (UpdateCompliancePolicyResponse);
  rpc UpdateCompliancePolicyDescription(UpdateCompliancePolicyDescriptionRequest) returns (UpdateCompliancePolicyResponse);
  rpc DeleteCompliancePolicy(DeleteCompliancePolicyRequest) returns (DeleteCompliancePolicyResponse);
  rpc AddCompliancePolicyRule(AddCompliancePolicyRuleRequest) returns (AddCompliancePolicyRuleResponse);
  rpc RemoveCompliancePolicyRule(RemoveCompliancePolicyRuleRequest) returns (RemoveCompliancePolicyRuleResponse);
  rpc UpdateCompliancePolicyRule(UpdateCompliancePolicyRuleRequest) returns (UpdateCompliancePolicyRuleResponse);
  rpc GetDeviceCompliancePolicyStatus(GetDeviceCompliancePolicyStatusRequest) returns (GetDeviceCompliancePolicyStatusResponse);

  // Device Authentication (PAM/NSS device login)
  rpc AuthenticateDeviceUser(AuthenticateDeviceUserRequest) returns (AuthenticateDeviceUserResponse);
  rpc GetDeviceLoginURL(GetDeviceLoginURLRequest) returns (GetDeviceLoginURLResponse);
  rpc DeviceLoginCallback(DeviceLoginCallbackRequest) returns (DeviceLoginCallbackResponse);
  rpc ListDeviceUsers(ListDeviceUsersRequest) returns (ListDeviceUsersResponse);

  // Search
  rpc Search(SearchRequest) returns (SearchResponse);
  rpc RebuildSearchIndex(RebuildSearchIndexRequest) returns (RebuildSearchIndexResponse);

  // Server Settings
  rpc GetServerSettings(GetServerSettingsRequest) returns (GetServerSettingsResponse);
  rpc UpdateServerSettings(UpdateServerSettingsRequest) returns (UpdateServerSettingsResponse);

  // User Provisioning Per-User
  rpc SetUserProvisioningEnabled(SetUserProvisioningEnabledRequest) returns (UpdateUserResponse);
}
