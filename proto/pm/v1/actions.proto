syntax = "proto3";

package pm.v1;

option go_package = "github.com/manchtools/power-manage/sdk/gen/go/pm/v1;pmv1";

import "google/protobuf/timestamp.proto";
import "pm/v1/common.proto";

// ============================================================================
// Action Types
// ============================================================================

enum ActionType {
  ACTION_TYPE_UNSPECIFIED = 0;

  // Package management (1-99)
  ACTION_TYPE_PACKAGE = 1;      // Generic package (apt/dnf/pacman based on distro)
  ACTION_TYPE_UPDATE = 2;       // System-wide package update (respects pinning)
  ACTION_TYPE_REPOSITORY = 3;   // External repository configuration

  // Application installation (100-199)
  ACTION_TYPE_APP_IMAGE = 100;  // AppImage
  ACTION_TYPE_DEB = 101;        // Direct .deb
  ACTION_TYPE_RPM = 102;        // Direct .rpm
  ACTION_TYPE_FLATPAK = 103;    // Flatpak application

  // Scripts (200-299)
  ACTION_TYPE_SHELL = 200;      // Shell script

  // Services (300-399)
  ACTION_TYPE_SYSTEMD = 300;    // Systemd unit

  // Files (400-499)
  ACTION_TYPE_FILE = 400;       // File management
  ACTION_TYPE_DIRECTORY = 401;  // Directory management

  // Instant actions (500-599) â€” agent-builtin, no parameters
  ACTION_TYPE_REBOOT = 500;     // Reboot the device (5-minute delay)
  ACTION_TYPE_SYNC = 501;       // Trigger immediate agent sync
}

// ============================================================================
// Action - Pushed from server to agent
// ============================================================================

message Action {
  // @gotags: validate:"required"
  ActionId id = 1;
  // @gotags: validate:"required,ne=0"
  ActionType type = 2;

  // @gotags: validate:"omitempty"
  DesiredState desired_state = 3;
  // @gotags: validate:"omitempty,gte=0,lte=3600"
  int32 timeout_seconds = 4;

  // Scheduling configuration for autonomous agent execution
  // @gotags: validate:"omitempty"
  ActionSchedule schedule = 5;

  // Type-specific parameters
  oneof params {
    PackageParams package = 10;
    AppInstallParams app = 11;
    ShellParams shell = 12;
    SystemdParams systemd = 13;
    FileParams file = 14;
    UpdateParams update = 15;
    RepositoryParams repository = 16;
    FlatpakParams flatpak = 17;
    DirectoryParams directory = 18;
  }

  // ECDSA signature over canonical action payload (signed by CA key).
  // Used to verify actions were created by the control server.
  bytes signature = 20;
  // Canonical JSON params used for signature verification.
  bytes params_canonical = 21;
}

// ActionSchedule defines when an action should be executed by the agent.
// Actions run autonomously on the agent even without server connection.
message ActionSchedule {
  // Cron expression for scheduled execution (e.g., "0 3 * * *" for 3am daily)
  // If empty, uses default_interval_hours instead.
  // @gotags: validate:"omitempty,max=128"
  string cron = 1;

  // Default interval in hours between executions (default: 8 hours for drift prevention)
  // Used when cron is not specified.
  // @gotags: validate:"omitempty,gte=0,lte=8760"
  int32 interval_hours = 2;

  // Whether to run immediately when the action is first received
  // @gotags: validate:"omitempty"
  bool run_on_assign = 3;

  // Whether to skip execution if the previous run was successful and no changes detected
  // @gotags: validate:"omitempty"
  bool skip_if_unchanged = 4;
}

// ============================================================================
// Action Parameters
// ============================================================================

message PackageParams {
  // Generic package name (used if manager-specific names not provided)
  // If set, this name is used for all package managers.
  // @gotags: validate:"omitempty,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=128"
  string version = 2;
  // @gotags: validate:"omitempty"
  bool allow_downgrade = 3;
  // @gotags: validate:"omitempty"
  bool pin = 4;

  // Manager-specific package names (override generic name)
  // If a manager-specific name is empty, that manager will be skipped.
  // @gotags: validate:"omitempty,max=255"
  string apt_name = 10;    // Debian/Ubuntu (apt/apt-get)
  // @gotags: validate:"omitempty,max=255"
  string dnf_name = 11;    // Fedora/RHEL (dnf/yum)
  // @gotags: validate:"omitempty,max=255"
  string pacman_name = 12; // Arch Linux (pacman)
  // @gotags: validate:"omitempty,max=255"
  string zypper_name = 13; // openSUSE (zypper)
}

message AppInstallParams {
  // @gotags: validate:"required,url"
  string url = 1;
  // @gotags: validate:"omitempty,len=64,hexadecimal"
  string checksum_sha256 = 2;
  // @gotags: validate:"omitempty,startswith=/"
  string install_path = 3;
}

message ShellParams {
  // @gotags: validate:"required,max=1048576"
  string script = 1;
  // @gotags: validate:"omitempty,max=255"
  string interpreter = 2;
  // @gotags: validate:"omitempty"
  bool run_as_root = 3;
  // @gotags: validate:"omitempty,startswith=/"
  string working_directory = 4;
  // @gotags: validate:"omitempty,dive,keys,max=255,endkeys,max=4096"
  map<string, string> environment = 5;
}

message SystemdParams {
  // @gotags: validate:"required,min=1,max=255"
  string unit_name = 1;
  // @gotags: validate:"omitempty"
  SystemdUnitState desired_state = 2;
  // @gotags: validate:"omitempty"
  bool enable = 3;
  // @gotags: validate:"omitempty,max=65536"
  string unit_content = 4;
}

enum SystemdUnitState {
  SYSTEMD_UNIT_STATE_UNSPECIFIED = 0;
  SYSTEMD_UNIT_STATE_STARTED = 1;
  SYSTEMD_UNIT_STATE_STOPPED = 2;
  SYSTEMD_UNIT_STATE_RESTARTED = 3;
}

message FileParams {
  // @gotags: validate:"required,startswith=/"
  string path = 1;
  // @gotags: validate:"omitempty,max=10485760"
  string content = 2;
  // @gotags: validate:"omitempty,max=32"
  string owner = 3;
  // @gotags: validate:"omitempty,max=32"
  string group = 4;
  // @gotags: validate:"omitempty,max=4"
  string mode = 5;
}

// DirectoryParams configures directory management.
// Creates or removes directories with optional ownership and permissions.
message DirectoryParams {
  // Directory path (must be absolute)
  // @gotags: validate:"required,startswith=/"
  string path = 1;
  // @gotags: validate:"omitempty,max=32"
  string owner = 2;
  // @gotags: validate:"omitempty,max=32"
  string group = 3;
  // @gotags: validate:"omitempty,max=4"
  string mode = 4;
  // Whether to create parent directories (like mkdir -p)
  // Default: true
  // @gotags: validate:"omitempty"
  bool recursive = 5;
}

// UpdateParams configures system-wide package updates.
// Respects version pinning (apt-mark hold / dnf versionlock).
message UpdateParams {
  // @gotags: validate:"omitempty"
  bool security_only = 1;         // Only install security updates (if supported)
  // @gotags: validate:"omitempty"
  bool autoremove = 2;            // Remove unused dependencies after update
  // @gotags: validate:"omitempty"
  bool reboot_if_required = 3;    // Reboot system if updates require it
}

// FlatpakParams configures Flatpak application installation.
// Similar to AppImage but uses the Flatpak package manager.
message FlatpakParams {
  // Application ID (e.g., "org.mozilla.firefox", "com.spotify.Client")
  // @gotags: validate:"required,min=1,max=255"
  string app_id = 1;

  // Remote/repository name (default: "flathub")
  // @gotags: validate:"omitempty,max=64"
  string remote = 2;

  // Whether to install system-wide (true) or user-only (false)
  // Default: true (system-wide)
  // @gotags: validate:"omitempty"
  bool system_wide = 3;

  // Pin the application to prevent automatic updates
  // @gotags: validate:"omitempty"
  bool pin = 4;
}

// RepositoryParams configures external package repositories.
// Each package manager has its own configuration format.
message RepositoryParams {
  // Repository name/identifier (used for file naming)
  // @gotags: validate:"required,min=1,max=64,alphanum"
  string name = 1;

  // APT repository configuration (Debian/Ubuntu)
  // @gotags: validate:"omitempty"
  AptRepository apt = 10;

  // DNF/YUM repository configuration (Fedora/RHEL)
  // @gotags: validate:"omitempty"
  DnfRepository dnf = 11;

  // Pacman repository configuration (Arch Linux)
  // @gotags: validate:"omitempty"
  PacmanRepository pacman = 12;

  // Zypper repository configuration (openSUSE)
  // @gotags: validate:"omitempty"
  ZypperRepository zypper = 13;
}

// AptRepository configures a Debian/Ubuntu APT repository.
message AptRepository {
  // Repository URL (e.g., "https://packages.example.com/apt")
  // @gotags: validate:"required_without=Disabled,omitempty,url"
  string url = 1;

  // Distribution codename (e.g., "jammy", "bookworm")
  // @gotags: validate:"omitempty,max=64"
  string distribution = 2;

  // Components (e.g., "main", "contrib", "non-free")
  // @gotags: validate:"omitempty,dive,max=64"
  repeated string components = 3;

  // GPG key URL for repository signing
  // @gotags: validate:"omitempty,url"
  string gpg_key_url = 4;

  // GPG key content (ASCII-armored, alternative to gpg_key_url)
  // @gotags: validate:"omitempty,max=65536"
  string gpg_key = 5;

  // Whether to use signed-by (modern) or trusted=yes (legacy, less secure)
  // @gotags: validate:"omitempty"
  bool trusted = 6;

  // Architecture filter (e.g., "amd64", "arm64")
  // @gotags: validate:"omitempty,max=32"
  string arch = 7;

  // Set to true to disable/skip this repository manager
  // @gotags: validate:"omitempty"
  bool disabled = 8;
}

// DnfRepository configures a Fedora/RHEL DNF/YUM repository.
message DnfRepository {
  // Base URL for the repository
  // @gotags: validate:"required_without=Disabled,omitempty,url"
  string baseurl = 1;

  // Repository description
  // @gotags: validate:"omitempty,max=255"
  string description = 2;

  // Whether the repository is enabled (default true)
  // @gotags: validate:"omitempty"
  bool enabled = 3;

  // Whether to check GPG signatures
  // @gotags: validate:"omitempty"
  bool gpgcheck = 4;

  // GPG key URL
  // @gotags: validate:"omitempty,url"
  string gpgkey = 5;

  // Module hotfixes (for modular content)
  // @gotags: validate:"omitempty"
  bool module_hotfixes = 6;

  // Set to true to disable/skip this repository manager
  // @gotags: validate:"omitempty"
  bool disabled = 7;
}

// PacmanRepository configures an Arch Linux pacman repository.
message PacmanRepository {
  // Server URL (can include $repo and $arch variables)
  // @gotags: validate:"required_without=Disabled,omitempty,url"
  string server = 1;

  // SigLevel (e.g., "Optional TrustAll", "Required DatabaseOptional")
  // @gotags: validate:"omitempty,max=128"
  string sig_level = 2;

  // Set to true to disable/skip this repository manager
  // @gotags: validate:"omitempty"
  bool disabled = 3;
}

// ZypperRepository configures an openSUSE zypper repository.
message ZypperRepository {
  // Repository URL
  // @gotags: validate:"required_without=Disabled,omitempty,url"
  string url = 1;

  // Repository description/alias
  // @gotags: validate:"omitempty,max=255"
  string description = 2;

  // Whether to enable the repository (default true)
  // @gotags: validate:"omitempty"
  bool enabled = 3;

  // Whether to auto-refresh the repository
  // @gotags: validate:"omitempty"
  bool autorefresh = 4;

  // Whether to check GPG signatures
  // @gotags: validate:"omitempty"
  bool gpgcheck = 5;

  // GPG key URL
  // @gotags: validate:"omitempty,url"
  string gpgkey = 6;

  // Repository type (e.g., "rpm-md", "yast2")
  // @gotags: validate:"omitempty,max=32"
  string type = 7;

  // Set to true to disable/skip this repository manager
  // @gotags: validate:"omitempty"
  bool disabled = 8;
}

// ============================================================================
// Action Result - Sent from agent to server
// ============================================================================

message ActionResult {
  // @gotags: validate:"required"
  ActionId action_id = 1;
  // @gotags: validate:"required"
  ExecutionStatus status = 2;
  // @gotags: validate:"omitempty,max=4096"
  string error = 3;
  // @gotags: validate:"omitempty"
  CommandOutput output = 4;
  // @gotags: validate:"omitempty"
  google.protobuf.Timestamp completed_at = 5;
  // @gotags: validate:"omitempty,gte=0"
  int64 duration_ms = 6;
}
