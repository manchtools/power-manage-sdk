syntax = "proto3";

package pm.v1;

option go_package = "github.com/manchtools/power-manage/sdk/gen/go/pm/v1;pmv1";

import "google/protobuf/timestamp.proto";
import "pm/v1/common.proto";

// ============================================================================
// Action Types
// ============================================================================

enum ActionType {
  ACTION_TYPE_UNSPECIFIED = 0;

  // Package management (1-99)
  ACTION_TYPE_PACKAGE = 1;      // Generic package (apt/dnf/pacman based on distro)
  ACTION_TYPE_UPDATE = 2;       // System-wide package update (respects pinning)

  // Application installation (100-199)
  ACTION_TYPE_APP_IMAGE = 100;  // AppImage
  ACTION_TYPE_DEB = 101;        // Direct .deb
  ACTION_TYPE_RPM = 102;        // Direct .rpm

  // Scripts (200-299)
  ACTION_TYPE_SHELL = 200;      // Shell script

  // Services (300-399)
  ACTION_TYPE_SYSTEMD = 300;    // Systemd unit

  // Files (400-499)
  ACTION_TYPE_FILE = 400;       // File management
}

// ============================================================================
// Action - Pushed from server to agent
// ============================================================================

message Action {
  // @gotags: validate:"required"
  ActionId id = 1;
  // @gotags: validate:"required,ne=0"
  ActionType type = 2;

  // @gotags: validate:"omitempty"
  DesiredState desired_state = 3;
  // @gotags: validate:"omitempty,gte=0,lte=3600"
  int32 timeout_seconds = 4;

  // Scheduling configuration for autonomous agent execution
  // @gotags: validate:"omitempty"
  ActionSchedule schedule = 5;

  // Type-specific parameters
  oneof params {
    PackageParams package = 10;
    AppInstallParams app = 11;
    ShellParams shell = 12;
    SystemdParams systemd = 13;
    FileParams file = 14;
    UpdateParams update = 15;
  }
}

// ActionSchedule defines when an action should be executed by the agent.
// Actions run autonomously on the agent even without server connection.
message ActionSchedule {
  // Cron expression for scheduled execution (e.g., "0 3 * * *" for 3am daily)
  // If empty, uses default_interval_hours instead.
  // @gotags: validate:"omitempty,max=128"
  string cron = 1;

  // Default interval in hours between executions (default: 8 hours for drift prevention)
  // Used when cron is not specified.
  // @gotags: validate:"omitempty,gte=0,lte=8760"
  int32 interval_hours = 2;

  // Whether to run immediately when the action is first received
  // @gotags: validate:"omitempty"
  bool run_on_assign = 3;

  // Whether to skip execution if the previous run was successful and no changes detected
  // @gotags: validate:"omitempty"
  bool skip_if_unchanged = 4;
}

// ============================================================================
// Action Parameters
// ============================================================================

message PackageParams {
  // Generic package name (used if manager-specific names not provided)
  // If set, this name is used for all package managers.
  // @gotags: validate:"omitempty,max=255"
  string name = 1;
  // @gotags: validate:"omitempty,max=128"
  string version = 2;
  // @gotags: validate:"omitempty"
  bool allow_downgrade = 3;
  // @gotags: validate:"omitempty"
  bool pin = 4;

  // Manager-specific package names (override generic name)
  // If a manager-specific name is empty, that manager will be skipped.
  // @gotags: validate:"omitempty,max=255"
  string apt_name = 10;    // Debian/Ubuntu (apt/apt-get)
  // @gotags: validate:"omitempty,max=255"
  string dnf_name = 11;    // Fedora/RHEL (dnf/yum)
  // @gotags: validate:"omitempty,max=255"
  string pacman_name = 12; // Arch Linux (pacman)
  // @gotags: validate:"omitempty,max=255"
  string zypper_name = 13; // openSUSE (zypper)
}

message AppInstallParams {
  // @gotags: validate:"required,url"
  string url = 1;
  // @gotags: validate:"omitempty,len=64,hexadecimal"
  string checksum_sha256 = 2;
  // @gotags: validate:"omitempty,startswith=/"
  string install_path = 3;
}

message ShellParams {
  // @gotags: validate:"required,max=1048576"
  string script = 1;
  // @gotags: validate:"omitempty,max=255"
  string interpreter = 2;
  // @gotags: validate:"omitempty"
  bool run_as_root = 3;
  // @gotags: validate:"omitempty,startswith=/"
  string working_directory = 4;
  // @gotags: validate:"omitempty,dive,keys,max=255,endkeys,max=4096"
  map<string, string> environment = 5;
}

message SystemdParams {
  // @gotags: validate:"required,min=1,max=255"
  string unit_name = 1;
  // @gotags: validate:"omitempty"
  SystemdUnitState desired_state = 2;
  // @gotags: validate:"omitempty"
  bool enable = 3;
  // @gotags: validate:"omitempty,max=65536"
  string unit_content = 4;
}

enum SystemdUnitState {
  SYSTEMD_UNIT_STATE_UNSPECIFIED = 0;
  SYSTEMD_UNIT_STATE_STARTED = 1;
  SYSTEMD_UNIT_STATE_STOPPED = 2;
  SYSTEMD_UNIT_STATE_RESTARTED = 3;
}

message FileParams {
  // @gotags: validate:"required,startswith=/"
  string path = 1;
  // @gotags: validate:"omitempty,max=10485760"
  string content = 2;
  // @gotags: validate:"omitempty,max=32"
  string owner = 3;
  // @gotags: validate:"omitempty,max=32"
  string group = 4;
  // @gotags: validate:"omitempty,max=4"
  string mode = 5;
}

// UpdateParams configures system-wide package updates.
// Respects version pinning (apt-mark hold / dnf versionlock).
message UpdateParams {
  // @gotags: validate:"omitempty"
  bool security_only = 1;         // Only install security updates (if supported)
  // @gotags: validate:"omitempty"
  bool autoremove = 2;            // Remove unused dependencies after update
  // @gotags: validate:"omitempty"
  bool reboot_if_required = 3;    // Reboot system if updates require it
}

// ============================================================================
// Action Result - Sent from agent to server
// ============================================================================

message ActionResult {
  // @gotags: validate:"required"
  ActionId action_id = 1;
  // @gotags: validate:"required"
  ExecutionStatus status = 2;
  // @gotags: validate:"omitempty,max=4096"
  string error = 3;
  // @gotags: validate:"omitempty"
  CommandOutput output = 4;
  // @gotags: validate:"omitempty"
  google.protobuf.Timestamp completed_at = 5;
  // @gotags: validate:"omitempty,gte=0"
  int64 duration_ms = 6;
}
